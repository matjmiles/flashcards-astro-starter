---
import '../styles.css';
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A&P Flashcards</title>
  </head>
  <body class="app">
    <header class="header">
      <h1>A&P Flashcards</h1>
      <select id="deckSelect" aria-label="Select deck"></select>
    </header>

    <main class="main">
      <div id="card" class="card" tabindex="0" aria-live="polite">
        <img id="front" alt="" />
        <div id="back" class="back" hidden></div>
      </div>

      <div class="controls">
        <button id="flip" class="btn">Flip</button>
        <button id="knew" class="btn good">I knew it</button>
        <button id="missed" class="btn bad">I missed it</button>
        <button id="next" class="btn">Next ➜</button>
      </div>

      <section class="stats">
        <div>Box 1: <span id="b1">0</span></div>
        <div>Box 2: <span id="b2">0</span></div>
        <div>Box 3: <span id="b3">0</span></div>
        <div>Total: <span id="total">0</span></div>
      </section>
    </main>

    <footer class="footer">
      <a href="/flashcards-astro-starter/decks/anatomy-bones.json" target="_blank" rel="noopener">View deck JSON</a>
      <span>· Offline-ready PWA</span>
    </footer>

    <script type="module">
      const seenKeyPrefix = 'deck-progress-v1:';
      let cards = [];
      let i = 0;
      let showingFront = true;
      let progress = {}; // index -> box (1..3)

      const $ = (id) => document.getElementById(id);

      const decks = [
        { name: 'Anatomy: Bones', file: 'anatomy-bones.json' }
      ];

      function loadProgress(key) {
        try {
          return JSON.parse(localStorage.getItem(key) || '{}');
        } catch {
          return {};
        }
      }
      function saveProgress(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }
      function updateStats() {
        let b1=0,b2=0,b3=0;
        for (const k in progress) {
          const v = progress[k];
          if (v===1) b1++; else if (v===2) b2++; else if (v===3) b3++;
        }
        $('b1').textContent = b1;
        $('b2').textContent = b2;
        $('b3').textContent = b3;
        $('total').textContent = cards.length;
      }

      async function loadDeck(deckFile) {
        const res = await fetch('/flashcards-astro-starter/decks/' + deckFile);
        cards = await res.json();
        i = 0; showingFront = true;
        progress = loadProgress(seenKeyPrefix + deckFile);
        render();
        fillDeckSelect(deckFile);
        updateStats();
      }

      function fillDeckSelect(current) {
        const sel = $('deckSelect');
        sel.innerHTML = '';
        for (const d of decks) {
          const opt = document.createElement('option');
          opt.value = d.file; opt.textContent = d.name;
          if (d.file === current) opt.selected = true;
          sel.appendChild(opt);
        }
        sel.onchange = () => loadDeck(sel.value);
      }

      function render() {
        const c = cards[i];
        if (!c) return;
        const front = $('front'), back = $('back');
        front.src = c.image;
        front.alt = c.alt || c.answer || 'Flashcard image';
        back.textContent = c.answer;
        back.hidden = showingFront;
      }

      function setBox(delta) {
        const val = Math.max(1, Math.min(3, (progress[i]||1) + delta));
        progress[i] = val;
        updateStats();
        saveProgress(seenKeyPrefix + $('deckSelect').value, progress);
      }

      $('flip').onclick = () => { showingFront = !showingFront; render(); };
      $('knew').onclick = () => { setBox(+1); next(); };
      $('missed').onclick = () => { setBox(-2); next(); };
      $('next').onclick = () => next();
      $('card').onclick = () => { showingFront = !showingFront; render(); };
      $('card').onkeydown = (e) => {
        if (['Enter',' '].includes(e.key)) { e.preventDefault(); $('flip').click(); }
        if (e.key === 'ArrowRight') $('next').click();
        if (e.key === 'ArrowUp') $('knew').click();
        if (e.key === 'ArrowDown') $('missed').click();
      };

      function next() {
        i = (i + 1) % cards.length;
        showingFront = true;
        render();
      }

      // boot
      loadDeck('anatomy-bones.json');
    </script>
  </body>
</html>
